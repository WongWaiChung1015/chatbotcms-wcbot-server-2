"use strict";function SetupInputInfo(){if(null!=window._shoppingCart.input_info){var n=$("#billing_form"),e=$("#shipping_form"),a=window._shoppingCart.input_info.billing;n.find('[name="first_name"]').val(a.first_name),n.find('[name="last_name"]').val(a.last_name),n.find('[name="email"]').val(a.email),n.find('[name="phone"]').val(a.phone),n.find('[name="address1"]').val(a.address1),n.find('[name="address2"]').val(a.address2),n.find('[name="city"]').val(a.city),n.find('[name="state"]').val(a.state),n.find('[name="postal"]').val(a.postal),n.find('[name="country"]').dropdown("set selected",a.country),OnFormCountryChanged(n,a.country),n.find('[name="state"]').dropdown("set selected",a.state);var i=window._shoppingCart.input_info.shipping;e.find('[name="first_name"]').val(i.first_name),e.find('[name="last_name"]').val(i.last_name),e.find('[name="address1"]').val(i.address1),e.find('[name="address2"]').val(i.address2),e.find('[name="city"]').val(i.city),e.find('[name="postal"]').val(i.postal),e.find('[name="country"]').dropdown("set selected",i.country),OnFormCountryChanged(e,i.country),e.find('[name="state"]').dropdown("set selected",i.state),a.first_name===i.first_name&&a.last_name===i.last_name&&a.address1===i.address1&&a.address2===i.address2&&a.city===i.city&&a.state===i.state&&a.postal===i.postal&&a.country===i.country&&($('[name="same_as_billing"]').prop("checked","checked"),e.find("input").each(function(n){$(this).prop("disabled",!0)}),e.find(".dropdown").each(function(n){$(this).addClass("disabled")}))}}function SetupUI(){$(".ui.search.dropdown").dropdown(),$(".ui.checkbox").checkbox(),$("#btn_proceed").click(onBtnProceed),$("#btn_back").click(onBtnBack),$('[name="same_as_billing"]').change(onCbSameAsBilling),$('#billing_form [name="country"]').on("change",function(n){OnFormCountryChanged($("#billing_form"),n.target.value)}),$('#shipping_form [name="country"]').on("change",function(n){OnFormCountryChanged($("#shipping_form"),n.target.value)}),$(".loading_wrapper").hide(),$(".loaded_wrapper").show()}function LoadShoppingCart(){return $.ajax({method:"GET",url:"ws/db_loadcart",data:{uid:window._userId,rid:window._recipientId}})}function CalcOrderTotal(){var n=0;$.each(window._shoppingCart.cart_items,function(e,a){n+=a._qty*a._unitPrice});var e=util.ParseCurrencyToDisp(window._shoppingCart.server_settings.currency,n);$("#order_total").html(e),$("#total_div").show()}function ExtractCountries(){var n={};$.each(window._shoppingCart.server_settings.country.options,function(e,a){var i=e.split(":"),t=i[0],o=a.split(" - "),r=o[0];null==n[t]?(n[t]={name:r},i.length>1&&(n[t].states={},n[t].states[i[1]]=o[1])):n[t].states[i[1]]=o[1]}),window._countries=n}function onCbSameAsBilling(n){var e=this.checked,a=$("#billing_form"),i=$("#shipping_form");if(a.find('[name="country"]').val()!=i.find('[name="country"]').val()){var t=a.find('[name="state"] > option').clone(),o=i.find('[name="state"]');o.dropdown("clear"),o.empty().append(t)}i.find("input, select").each(function(n){var i=$(this).prop("name");if(i.length>0){if(e){var t=a.find('[name="'+i+'"]').val();"SELECT"===this.tagName?($(this).dropdown("setup select"),$(this).dropdown("set selected",t),$(this).dropdown("refresh")):$(this).val(t)}"INPUT"===this.tagName?$(this).prop("disabled",e):"SELECT"===this.tagName&&(e?$(this).parent().addClass("disabled"):$(this).parent().removeClass("disabled"))}})}function CountryCommonBehavior(n){var e='<option value="">Type to search</option>',a=n.find('[name="country"]');$.each(window._countries,function(n,a){e+='<option value="'+n+'">'+a.name+"</option>"}),a.html(e),a.dropdown("refresh")}function SetupBillingForm(){var n=$("#billing_form");CountryCommonBehavior(n),n.form({on:"blur",inline:!0,fields:{first_name:{identifier:"first_name",rules:[{type:"empty"}]},last_name:{identifier:"last_name",rules:[{type:"empty"}]},email:{identifier:"email",rules:[{type:"email"}]},phone:{identifier:"phone",rules:[{type:"empty"}]},address1:{identifier:"address1",rules:[{type:"empty"}]},postal:{identifier:"postal",rules:[{type:"regExp",value:"/^[a-zA-Z0-9]*$/",prompt:"Alphanumeric characters only"}]},country:{identifier:"country",rules:[{type:"empty"}]}}}),n.submit(function(n){if(!$(this).form("is valid"))return n.preventDefault(),!1;var e='<input type="hidden" name="payment_gateway" value="'+window.payment_gateway+'" />';return $(this).append(e),!0})}function SetupShippingForm(){var n=$("#shipping_form");CountryCommonBehavior(n),n.form({on:"blur",inline:!0,fields:{first_name:{identifier:"first_name",rules:[{type:"empty"}]},last_name:{identifier:"last_name",rules:[{type:"empty"}]},address1:{identifier:"address1",rules:[{type:"empty"}]},postal:{identifier:"postal",rules:[{type:"regExp",value:"/^[a-zA-Z0-9]*$/",prompt:"Can't contains hypen"}]},country:{identifier:"country",rules:[{type:"empty"}]}}}),n.submit(function(n){if(!$(this).form("is valid"))return n.preventDefault(),!1;var e='<input type="hidden" name="payment_gateway" value="'+window.payment_gateway+'" />';return $(this).append(e),!0})}function OnFormCountryChanged(n,e){var a,i=n.find('[name="state"]'),t=window._countries[e].states;null==t?a='<option value="">Type to search</option>':(a='<option value="">Type to search</option>',$.each(t,function(n,e){a+='<option value="'+n+'">'+e+"</option>"})),i.html(a),i.dropdown("clear"),i.dropdown("refresh"),i.dropdown("setup select")}function onBtnProceed(n){if($("#billing_form").form("validate form")){var e=$('[name="same_as_billing"]').prop("checked"),a=null;if(e?a=$('#billing_form [name="country"]').val():$("#shipping_form").form("validate form")&&(a=$('#shipping_form [name="country"]').val()),a){var i=$("#billing_form"),t={billing:{first_name:i.find('[name="first_name"]').val(),last_name:i.find('[name="last_name"]').val(),email:i.find('[name="email"]').val(),phone:i.find('[name="phone"]').val(),address1:i.find('[name="address1"]').val(),address2:i.find('[name="address2"]').val(),city:i.find('[name="city"]').val(),state:i.find('[name="state"]').val(),postal:i.find('[name="postal"]').val(),country:i.find('[name="country"]').val()}};if(e){var o=JSON.stringify(t.billing);t.shipping=JSON.parse(o)}else i=$("shipping_form"),t.shipping={first_name:i.find('[name="first_name"]').val(),last_name:i.find('[name="last_name"]').val(),address1:i.find('[name="address1"]').val(),address2:i.find('[name="address2"]').val(),city:i.find('[name="city"]').val(),state:i.find('[name="state"]').val(),postal:i.find('[name="postal"]').val(),country:i.find('[name="country"]').val()};EnableAllButtons(!1),window._shoppingCart.input_info=t,SaveCart().done(function(n){"ok"===n&&(window.location.href="mwp?page=orderShipping&uid="+window._userId+"&rid="+window._recipientId)}).fail(function(n,e,a){EnableAllButtons(!0)})}}}function onBtnBack(n){var e=$("#dlg_discardwarn");e.modal("show"),e.find("#btn_ok").click(function(n){EnableAllButtons(!1);var e="mwp?page=shopCart&uid="+window._userId+"&rid="+window._recipientId;window.location.href=e}),e.find("#btn_cancel").click(function(n){$("#dlg_discardwarn").modal("hide")})}function SaveCart(){return delete window._shoppingCart.cart_items,delete window._shoppingCart.server_settings,delete window._shoppingCart.order_pool,$.ajax({type:"POST",url:"ws/db_savecart",data:JSON.stringify({userId:window._userId,recipientId:window._recipientId,cart:window._shoppingCart}),contentType:"application/json"})}function EnableAllButtons(n){n?($("#btn_proceed").removeClass("disabled loading"),$("#btn_back").removeClass("disabled loading")):($("#btn_proceed").addClass("disabled loading"),$("#btn_back").addClass("disabled loading"))}$(document).ready(function(){CalcOrderTotal(),ExtractCountries(),SetupBillingForm(),SetupShippingForm(),SetupInputInfo(),SetupUI()});