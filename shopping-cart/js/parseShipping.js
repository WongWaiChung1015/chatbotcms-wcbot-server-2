var REGEX_SPACE=/\s+/,REGEX_NUM=/[0-9]+(?:\.[0-9]+)?\b/,REGEX_QTY=/\[\s*(qty)\s*\]/,REGEX_FEE=/\[\s*(fee) \s*(.+?)\s*\]/;function CreateLexer(){var e=new Lexer;return e.addRule(REGEX_SPACE,function(){}),e.addRule(REGEX_FEE,function(e){return e}),e.addRule(REGEX_QTY,function(e){return e}),e.addRule(REGEX_NUM,function(e){return e}),e.addRule(/[\(\+\-\*\/\)]/,function(e){return e}),e}function ParseWithLexer(e){var r={precedence:2,associativity:"left"},t={precedence:1,associativity:"left"},n=CreateLexer(),a=new Parser({"+":t,"-":t,"*":r,"/":r});var f=[],l={"+":function(e,r){return e+r},"-":function(e,r){return e-r},"*":function(e,r){return e*r},"/":function(e,r){return e/r}};$.each(function(e){n.setInput(e);for(var r,t=[];r=n.lex();)t.push(r);return a.parse(t)}(e),function(e,r){switch(r){case"+":case"-":case"*":case"/":var t=+f.pop(),n=+f.pop();f.push(l[r](n,t));break;default:if(/^\d+/.test(r))f.push(parseFloat(r));else if(REGEX_QTY.test(r)){var a=CalcOrderTotalQty();f.push(a)}else if(REGEX_FEE.test(r)){var s,u,i=REGEX_FEE.exec(r)[2],c=/^.*percent\s*\=\s*"*(\s*[0-9]+)"*\s*/.exec(i);c&&2===c.length&&(s=parseFloat(c[1])),(c=/^.*min_fee\s*\=\s*"*(\s*[0-9]+)"*\s*/.exec(i))&&2===c.length&&(u=parseFloat(c[1]));var o=CalcFee(s,u);f.push(o)}}});var s=f.pop();return s}function CalcFee(e,r){var t=CalcOrderTotalAmount();return null!=e&&(t=t*e/100),null!=r&&(t=t<r?r:t),t}function CalcOrderTotalAmount(){var t=0;return $.each(window._wcOrder.line_items,function(e,r){t+=parseFloat(r.subtotal)}),t}function CalcOrderTotalQty(){var t=0;return $.each(window._wcOrder.line_items,function(e,r){t+=r.quantity}),t}function Parser(e){this.table=e}Parser.prototype.parse=function(e){for(var r=e.length,t=this.table,n=[],a=[],s=0;s<r;){switch(f=e[s++]){case"(":a.unshift(f);break;case")":for(;a.length;){if("("===(f=a.shift()))break;n.push(f)}if("("!==f)throw new Error("Mismatched parentheses.");break;default:if(t.hasOwnProperty(f)){for(;a.length;){var u=a[0];if("("===u)break;var i=t[f],c=i.precedence,o=t[u].precedence;if(o<c||c===o&&"right"===i.associativity)break;n.push(a.shift())}a.unshift(f)}else n.push(f)}}for(;a.length;){var f;if("("===(f=a.shift()))throw new Error("Mismatched parentheses.");n.push(f)}return n};